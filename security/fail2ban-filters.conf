# AdCopySurge Custom Fail2ban Filters
# These filters detect application-specific attack patterns

# ============================================================================
# Authentication-related attacks
# ============================================================================

[adcopysurge-auth]
# Detect failed authentication attempts
failregex = ^<HOST> - .* "(POST|PUT|PATCH) /api/auth/(login|register|token)" (401|403|422|429)
            ^<HOST> - .* "POST /api/auth/login" 401.*$
            ^<HOST> - .* "POST /api/auth/register" 422.*$
            ^<HOST> - .* "POST /api/auth/token" 401.*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" /api/auth/

# ============================================================================
# API abuse patterns
# ============================================================================

[adcopysurge-api-abuse]
# Detect API abuse patterns (excessive requests, unusual patterns)
failregex = ^<HOST> - .* "(POST|PUT|PATCH|DELETE)" /api/ads/analyze 429.*$
            ^<HOST> - .* "(POST|PUT|PATCH|DELETE)" /api/ads/generate-alternatives 429.*$
            ^<HOST> - .* "POST /api/subscriptions/" 429.*$
            ^<HOST> - .* "(GET|POST|PUT|DELETE)" .* 429.*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" .*200.*$

[adcopysurge-dos]
# Detect potential DoS patterns (high frequency requests)
failregex = ^<HOST> - .* ".*" [4-5][0-9][0-9].*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" .* (200|301|302|304).*$

# ============================================================================
# Suspicious activity patterns
# ============================================================================

[adcopysurge-suspicious]
# Detect suspicious requests and reconnaissance
failregex = ^<HOST> - .* "(GET|POST|PUT|DELETE|HEAD)" .*(\.php|\.asp|\.aspx|\.jsp|wp-admin|phpmyadmin|admin|login\.php|xmlrpc\.php|\.git|\.svn|\.env|config\.php|backup|\.sql|\.bak|\.log).*$
            ^<HOST> - .* "(GET|POST)" .*/\.\./.*$
            ^<HOST> - .* "(GET|POST)" .*%[0-9a-fA-F][0-9a-fA-F].*$
            ^<HOST> - .* "(GET|POST)" .*(script|javascript|vbscript|onload|onerror|eval|expression).*$
            ^<HOST> - .* "(GET|POST)" .*(cmd|exec|system|shell|bash|powershell).*$
            ^<HOST> - .* ".*" 403 .*"Forbidden.*"
            ^<HOST> - .* ".*" 400 .*"Bad Request".*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" /api/(health|docs|redoc|openapi\.json) 200.*$

# ============================================================================
# SQL Injection attempts
# ============================================================================

[adcopysurge-sql-injection]
# Detect SQL injection attempts (zero tolerance)
failregex = ^<HOST> - .* "(GET|POST|PUT|DELETE)" .*(union|select|insert|delete|update|drop|exec|script|expression|declare|cast|convert|information_schema|sys\.|master\.|msdb\.|tempdb\.|xp_|sp_).*$
            ^<HOST> - .* "(GET|POST|PUT|DELETE)" .*(or\s+1=1|and\s+1=1|'=\s*'|"\s*=\s*"|'--|\s--|\s#|/\*|\*/|@@|char\(|nchar\(|varchar\(|nvarchar\(|waitfor|delay).*$
            ^<HOST> - .* "POST" .* 403 .*"Suspicious query.*".*$
            ^<HOST> - .* ".*" 403 .*"Suspicious.*parameters".*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" /api/(health|docs) 200.*$

# ============================================================================
# Application-specific abuse
# ============================================================================

[adcopysurge-registration]
# Detect registration abuse
failregex = ^<HOST> - .* "POST /api/auth/register" (422|429|400).*$
            ^<HOST> - .* "POST /api/auth/register.*email.*exists".*$
ignoreregex = ^<HOST> - .* "POST /api/auth/register" 201.*$

[adcopysurge-password-reset]
# Detect password reset abuse
failregex = ^<HOST> - .* "POST /api/auth/reset-password" (422|429|400|404).*$
            ^<HOST> - .* "POST /api/auth/forgot-password" 429.*$
ignoreregex = ^<HOST> - .* "POST /api/auth/reset-password" 200.*$

# ============================================================================
# File upload abuse
# ============================================================================

[adcopysurge-upload-abuse]
# Detect malicious file upload attempts
failregex = ^<HOST> - .* "POST" .*upload.* (413|415|422).*$
            ^<HOST> - .* "POST" .* 413 .*"Request entity too large".*$
            ^<HOST> - .* "POST" .* 400 .*"suspicious content".*$
ignoreregex = ^<HOST> - .* "POST" .*upload.* 200.*$

# ============================================================================
# CSRF and security violations
# ============================================================================

[adcopysurge-csrf]
# Detect CSRF attempts
failregex = ^<HOST> - .* "(POST|PUT|PATCH|DELETE)" /api/.* 403 .*"CSRF.*".*$
            ^<HOST> - .* "(POST|PUT|PATCH|DELETE)" .* 403 .*"token.*invalid".*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" .*$

# ============================================================================
# Rate limiting violations
# ============================================================================

[adcopysurge-rate-limit]
# Detect rate limit violations (handled by Nginx and application)
failregex = ^<HOST> - .* ".*" 429 .*"Too Many Requests".*$
            ^<HOST> - .* ".*" 429 .*"Rate limit exceeded".*$
            ^<HOST> - .* ".*" 503 .*"Service Temporarily Unavailable".*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" .* 200.*$

# ============================================================================
# Bot and crawler detection
# ============================================================================

[adcopysurge-bad-bots]
# Detect malicious bots and scrapers
failregex = ^<HOST> - .* "(.*sqlmap.*|.*nikto.*|.*nessus.*|.*masscan.*|.*nmap.*|.*bot.*|.*crawler.*|.*scraper.*|.*spider.*)" ".*" .*$
            ^<HOST> - .*".*" ".*" 403 "Forbidden User Agent".*$
ignoreregex = ^<HOST> - .* "(Googlebot|Bingbot|facebookexternalhit|Twitterbot|LinkedInBot)" .*$

# ============================================================================
# Geo-blocking violations
# ============================================================================

[adcopysurge-geo-block]
# Detect attempts from blocked countries (if geo-blocking is enabled)
failregex = ^<HOST> - .* ".*" 403 "Access denied from your location".*$
ignoreregex = 

# ============================================================================
# Generic security violations
# ============================================================================

[adcopysurge-security-violation]
# Catch-all for various security violations
failregex = ^<HOST> - .* ".*" 403 "Forbidden.*".*$
            ^<HOST> - .* ".*" 400 "Bad Request".*$
            ^<HOST> - .* ".*" 406 "Not Acceptable".*$
            ^<HOST> - .* ".*" 418 .*$  # I'm a teapot (often used for bot blocking)
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" /api/(health|docs|redoc|openapi\.json) (200|404).*$

# ============================================================================
# XSS and injection attempts
# ============================================================================

[adcopysurge-xss]
# Detect XSS attempts
failregex = ^<HOST> - .* "(GET|POST)" .*(<script|javascript:|vbscript:|onload=|onerror=|eval\(|document\.cookie|window\.location).*$
            ^<HOST> - .* "(GET|POST)" .*(%3Cscript|%3Ejavascript|%3Evbscript).*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" /api/(docs|redoc) 200.*$

# ============================================================================
# Directory traversal attempts
# ============================================================================

[adcopysurge-directory-traversal]
# Detect directory traversal attempts
failregex = ^<HOST> - .* "(GET|POST)" .*(\.\.\/|\.\.\%2F|%2e%2e%2f|%2e%2e\/|\.\.\\|%2e%2e%5c).*$
            ^<HOST> - .* "(GET|POST)" .*(\/etc\/|\/var\/|\/usr\/|\/bin\/|\/sbin\/|\/root\/|C:\\|D:\\).*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" /api/.*$

# ============================================================================
# Command injection attempts
# ============================================================================

[adcopysurge-command-injection]
# Detect command injection attempts
failregex = ^<HOST> - .* "(GET|POST|PUT)" .*(;|&&|\|\||`|\$\(|%60|%7C|%3B|%26|%24%28).*$
            ^<HOST> - .* "(GET|POST|PUT)" .*(cmd|exec|system|shell|bash|sh|powershell|wget|curl|nc|netcat).*$
ignoreregex = ^<HOST> - .* "(GET|OPTIONS)" /api/(docs|health) 200.*$