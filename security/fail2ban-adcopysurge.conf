# AdCopySurge Fail2ban Configuration
# This configuration provides comprehensive protection against various attack types

[DEFAULT]
# Default ban settings
bantime = 3600        # 1 hour ban time
findtime = 600        # 10 minutes observation window  
maxretry = 5          # Maximum attempts before ban
backend = auto        # Auto-detect log backend

# Email notifications (configure SMTP in fail2ban configuration)
destemail = security@adcopysurge.com
sender = fail2ban@adcopysurge.com
mta = sendmail

# Ban action with email notification
action_with_email = %(banaction)s[name=%(__name__)s, port="%(port)s", protocol="%(protocol)s", chain="%(chain)s"]
                   %(mta)s-whois[name=%(__name__)s, dest="%(destemail)s", protocol="%(protocol)s", chain="%(chain)s"]

# Default action (ban only, add email if needed)
action = %(action_with_email)s

# Ignore local networks
ignoreip = 127.0.0.1/8 ::1 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16

# ============================================================================
# SSH Protection
# ============================================================================

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
backend = %(sshd_backend)s
maxretry = 3
bantime = 7200        # 2 hours for SSH attacks
findtime = 600

[sshd-ddos]
enabled = true
port = ssh
logpath = /var/log/auth.log
backend = %(sshd_backend)s
maxretry = 2
bantime = 86400       # 24 hours for SSH DDoS
findtime = 300

# ============================================================================
# Nginx/HTTP Protection
# ============================================================================

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/*access.log
maxretry = 3
bantime = 1800
findtime = 600

[nginx-limit-req]
enabled = true
port = http,https
logpath = /var/log/nginx/*error.log
maxretry = 10
bantime = 1800
findtime = 600

[nginx-botsearch]
enabled = true
port = http,https
logpath = /var/log/nginx/*access.log
maxretry = 5
bantime = 3600
findtime = 300

[nginx-badbots]
enabled = true
port = http,https
logpath = /var/log/nginx/*access.log
maxretry = 3
bantime = 86400       # 24 hours for bad bots
findtime = 600

[nginx-noscript]
enabled = true
port = http,https
logpath = /var/log/nginx/*access.log
maxretry = 6
bantime = 86400
findtime = 300

[nginx-noproxy]
enabled = true
port = http,https
logpath = /var/log/nginx/*access.log
maxretry = 0
bantime = 86400
findtime = 600

# ============================================================================
# AdCopySurge Application Protection
# ============================================================================

[adcopysurge-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/adcopysurge-api.access.log
filter = adcopysurge-auth
maxretry = 5
bantime = 3600
findtime = 300
action = %(action_with_email)s

[adcopysurge-api-abuse]
enabled = true
port = http,https
logpath = /var/log/nginx/adcopysurge-api.access.log
filter = adcopysurge-api-abuse
maxretry = 10
bantime = 7200
findtime = 600

[adcopysurge-suspicious]
enabled = true
port = http,https
logpath = /var/log/nginx/adcopysurge-api.access.log
filter = adcopysurge-suspicious
maxretry = 3
bantime = 86400       # 24 hours for suspicious activity
findtime = 600

[adcopysurge-sql-injection]
enabled = true
port = http,https
logpath = /var/log/nginx/adcopysurge-api.access.log
filter = adcopysurge-sql-injection
maxretry = 1          # Zero tolerance for SQL injection
bantime = 604800      # 1 week ban
findtime = 3600

[adcopysurge-dos]
enabled = true
port = http,https
logpath = /var/log/nginx/adcopysurge-api.access.log
filter = adcopysurge-dos
maxretry = 100
bantime = 1800
findtime = 60         # 1 minute window for DoS detection

# ============================================================================
# Application-specific Filters
# ============================================================================

[adcopysurge-registration-abuse]
enabled = true
port = http,https
logpath = /var/log/nginx/adcopysurge-api.access.log
filter = adcopysurge-registration
maxretry = 3
bantime = 86400
findtime = 3600

[adcopysurge-password-reset-abuse]
enabled = true
port = http,https
logpath = /var/log/nginx/adcopysurge-api.access.log
filter = adcopysurge-password-reset
maxretry = 5
bantime = 3600
findtime = 1800

# ============================================================================
# Generic Web Attacks
# ============================================================================

[apache-shellshock]
enabled = true
port = http,https
logpath = /var/log/nginx/*access.log
maxretry = 1
bantime = 86400

[apache-overflows]
enabled = true
port = http,https
logpath = /var/log/nginx/*access.log
maxretry = 2
bantime = 86400

[apache-modsecurity]
enabled = true
port = http,https
logpath = /var/log/nginx/*error.log
maxretry = 2
bantime = 86400

# ============================================================================
# System Protection
# ============================================================================

[recidive]
# Ban repeat offenders for longer periods
enabled = true
logpath = /var/log/fail2ban.log
banaction = %(banaction_allports)s
bantime = 604800      # 1 week
findtime = 86400      # 24 hours
maxretry = 5

[postfix]
enabled = false       # Disable if not using mail server
port = smtp,465,submission
logpath = /var/log/mail.log

[dovecot]
enabled = false       # Disable if not using mail server
port = pop3,pop3s,imap,imaps,submission,465,sieve
logpath = /var/log/mail.log

# ============================================================================
# Custom Actions for Enhanced Security
# ============================================================================

# Custom action to also report to security monitoring
[action_and_report]
actionstart = <blocktype>
actionstop = <unblocktype>
actioncheck = <checktype>
actionban = <blocktype>
            echo "fail2ban: banned <ip> for <name> at $(date)" | logger -t fail2ban-security
            # Optional: Send to external security service
            # curl -X POST "https://api.example.com/security/ban" -d "ip=<ip>&jail=<name>"
actionunban = <unblocktype>
              echo "fail2ban: unbanned <ip> for <name> at $(date)" | logger -t fail2ban-security